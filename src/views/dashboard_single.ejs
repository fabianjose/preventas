<%- include ('partials/header')  %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
  <div class="container row">
    <div class="row mb-3 mt-3">
      <h2>Estadística del mes: <span class="mes-number"><%= mes+1 %></span></h2>
      <% if( usuario.rol  = 2 ){ %>
    <div class="col-md-5 form-group">
    <label class="label">Usuarios: </label>
    <select  class="form-control custom-select select-id">
      <option  value="<%= usuario[0].id %>" selected="">Todos</option>
      <% hijos.forEach(hijo =>  { %>
      <option value="<%- hijo.id %>"><%=  hijo.nombre %></option>
                <% }) %>
      </select>
    </div>
<%
  }
%>
    <div class="col-md-5 form-group">
              <label>Mes: </label>
              <select class="form-control custom-select select-mes">
                 <option value="0" <%= (mes == 0)?"selected":"" %>>Enero</option>
                 <option value="1"  <%= (mes == 1)?"selected":"" %>>Febrero</option>
                 <option value="2"  <%= (mes == 2)?"selected":"" %>>Marzo</option>
                 <option value="3"  <%= (mes == 3)?"selected":"" %>>Abril</option>
                 <option value="4" <%= (mes == 4)?"selected":"" %>>Mayo</option>
                 <option value="5"  <%= (mes == 5)?"selected":"" %>>Junio</option>
                 <option value="6" <%= (mes == 6)?"selected":"" %>>Julio</option>
                 <option value="7" <%= (mes == 7)?"selected":"" %>>Agosto</option>
                 <option value="8" <%= (mes == 8)?"selected":"" %>>Septiembre</option>
                 <option value="9" <%= (mes == 9)?"selected":"" %>>Octubre</option>
                 <option value="10" <%= (mes == 10)?"selected":"" %>>Noviembre</option>
                 <option value="11" <%= (mes == 11)?"selected":"" %>>Diciembre</option>
              </select>
              </div>
              <div class="col-md-2 form-group">
              <label>Año: </label>
              <select  class="form-control custom-select select-year">
                 <option value="2018" <%= (year == 2018)?"selected":"" %>>2018</option>
                 <option value="2019"  <%= (year == 2019)?"selected":"" %>>2019</option>
                 <option value="2020"  <%= (year  == 2020)?"selected":"" %>>2020</option>
                 <option value="2021"  <%= (year == 2021)?"selected":"" %>>2021</option>
              </select>
              </div>
            </div>
           <div class="col-md-4 text-center">
            <h4>Hogar</h4>
            <canvas  id="myChartHogar" width="400" height="300"></canvas></div>
            <div class="col-md-4 text-center">
            <h4>Pyme</h4><canvas  id="myChartPyme" width="400" height="300"></canvas></div>
            <div class="col-md-4 text-center">
            <h4>Avanzado</h4> <canvas  id="myChartAvanzado" width="400" height="300"></canvas></div>
            <div>
           <div class="row mt-4">
            <div class="col-md-6 text-center">
              <h4>Ventas Mensuales</h4>
            <canvas id="myChart" width="600" height="600"></canvas>
            </div>
           </div>
<script>

var data
function actualizar(mes = <%= mes %>, id = 1){
  mes =  $(".select-mes").val()
  year = $(".select-year").val()
  id = $(".select-id").val()
$.get("/estadistica/1/"+id+"/"+mes+"/"+year, a =>{
    console.log(a)
    meses = a.ventas.map(m =>{
     return m.reduce((ac, v)=>{ return ac + v.reduce((acu, u)=>{ return acu +  u },0) },0)
    })
    console.log(a.ventas)
   meta_hogar = a.metas[mes][1]
   console.log(meta_hogar)
   meta_lograda = a.ventas[ mes][1][3]
   meta_en_proceso = a.ventas[ mes][1][1]
   meta_hogar = meta_hogar - meta_lograda - meta_en_proceso
  if(meta_hogar < 0 )meta_hogar = 0  
    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx, {
    type: 'radar',
    data: {
        labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'],
        datasets: [{
            label: 'Ventas',
            data: meses,
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        scale: {
          ticks: {
            beginAtZero: true
          }
        }
    }
});

var ctx = document.getElementById('myChartHogar').getContext('2d');

var myChart = new Chart(ctx, {
     type: 'doughnut',
    data: {
        labels: ['Cerrado Ganado', 'Agendado', 'Falta Meta'],
        datasets: [{
            label: 'Hogar',
            data: [meta_lograda,meta_en_proceso ,meta_hogar],
            backgroundColor: [
                'rgba(0, 255, 50, 0.9)',
                'rgba(0, 255, 50, 0.5)',
                'rgba(255, 255,255, 0.2)'
                
            ],
            borderColor: [
               'rgba(0, 255, 50,1)',
                   'rgba(0, 255, 50,1)',
   'rgba(0, 255, 50, 1)'
               
            ],
            borderWidth: 1
        }]
    },
  options:{
    circumference:  Math.PI,
    rotation : -Math.PI 
  }
    
});
meta_pyme = a.metas[mes][2]
   meta_lograda = a.ventas[mes][2][3]
   meta_en_proceso = a.ventas[mes][2][1]
   meta_pyme = meta_pyme - meta_lograda - meta_en_proceso
   if(meta_pyme < 0)meta_pyme = 0;
var ctx1 = document.getElementById('myChartPyme').getContext('2d');
var myChart1 = new Chart(ctx1, {
     type: 'doughnut',
    data: {
        labels: ['Cerrado Ganado', 'Agendado', 'Falta Meta'],
        datasets: [{
            label: 'Pyme',
            data: [meta_lograda, meta_en_proceso, meta_pyme],
            backgroundColor: [
                'rgba(0, 50, 255, 0.9)',
                'rgba(0, 50, 255, 0.5)',
                'rgba(255, 255,255, 0.2)'
                
            ],
            borderColor: [
                'rgba(0, 50, 255, 0.7)',
                  'rgba(0, 50, 255, 0.7)',
  'rgba(0, 50, 255, 0.7)'
               
            ],
            borderWidth: 1
        }]
    },
  options:{
    circumference:  Math.PI,
    rotation : -Math.PI 
  }
    
});
var ctx2 = document.getElementById('myChartAvanzado').getContext('2d');

meta_avanzado = a.metas[mes][3]
   meta_lograda = a.ventas[mes][3][3]
   meta_en_proceso = a.ventas[mes][3][0]
   meta_avanzado = meta_avanzado - meta_lograda - meta_en_proceso
   if(meta_avanzado < 0 )meta_avanzado = 0
var myChart2 = new Chart(ctx2, {
     type: 'doughnut',
    data: {
        labels: ['Cerrado Ganado', 'Agendado', 'Falta Meta'],
        datasets: [{
            label: 'Avanzado',
            data: [meta_lograda, meta_en_proceso, meta_avanzado],
            backgroundColor: [
                'rgba(255, 50, 0, 0.9)',
                'rgba(255, 50, 0, 0.5)',
                'rgba(255, 255,255, 0.2)'
                
            ],
            borderColor: [
                'rgba(255, 50, 0, 0.8)',
                  'rgba(255, 50, 0, 0.8)',
  'rgba(255, 50, 0, 0.8)'
               
            ],
            borderWidth: 1
        }]
    },  options:{
    circumference:  Math.PI,
    rotation : -Math.PI 
  }
 
    
});})

}
$("select").change(()=>{
    actualizar()
    $('.mes-number').text(parseInt( $('.select-mes').val()) + 1)
  })
actualizar()
</script>
 <%- include('partials/footer') %>